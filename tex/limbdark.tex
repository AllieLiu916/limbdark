\documentclass[modern]{aastex61}

\input{stylez}
\usepackage{graphicx}

\begin{document}%\raggedbottom\sloppy\sloppypar\frenchspacing

\setlength{\abovedisplayskip}{1.5em}
\setlength{\belowdisplayskip}{1.5em}

\title{%
    Analytic Transit Light Curves for Limb-Darkened Stars
}

\author[0000-0002-0296-3826]{Rodrigo Luger}
\affil{Department~of~Astronomy, University~of~Washington, Seattle, WA}
\author{Eric Agol}
\affil{Department~of~Astronomy, University~of~Washington, Seattle, WA}

\keywords{methods: analytic --- techniques: photometric}

\begin{abstract}
    We derive analytic, closed-form solutions for the light curve
    of a planet transiting a star with a limb darkening profile of
    arbitrary integer order.  We provide updated expressions for the linear
    and quadratically limb darkened cases that are numerically stable
    over the entire domain.  Our expressions are fast to evaluate,
    allow for the integration over exposure time adaptively, and
    can be used to compute the first partial derivatives.
\end{abstract}

% ==============================================================================
% ------------------------------------------------------------------------------
% ------------------------------------------------------------------------------
%
\section{Introduction}
\label{sec:intro}
% ------------------------------------------------------------------------------
% ------------------------------------------------------------------------------
% ==============================================================================

\citet{Gimenez2006} derived transit light curves for a limb-darkening
function
\begin{equation}
I(\upmu) = I(1) \left[\sum_{n=1}^N a_n (1-\upmu^n) \right],
\end{equation}
where $\upmu = \cos{\theta} =\sqrt{1-r^2}$, where $\theta$ is the polar angle measured from the
sub-observer point), $r$ is the normalized stellar radius projected on the sky
$0\le r \le 1$, and $u_n$ is a limb-darkening coefficient.  \cite{Gimenez2006}
found an infinite series for computing the limb-darkened light curve for each $u_n$
term.  Here we present closed-form expressions for these terms which can be
easily computed with recursion relations.

\begin{itemize}
\item \cite{Pal2008} derived the partial derivatives of the quadratic limb-darkening model
with respect to $b$ and $r$.
\end{itemize}

% ==============================================================================
% ------------------------------------------------------------------------------
% ------------------------------------------------------------------------------
%
\section{Linear Limb-Darkening}
\label{sec:reparam}
% ------------------------------------------------------------------------------
% ------------------------------------------------------------------------------
% ==============================================================================

From \citet{MandelAgol2002}, the total flux visible during the occultation of a
body whose surface map is given by $I(x, y) = \sqrt{1 - \x^2 -\y^2}$ may be computed
as
%
\begin{align}
    \label{eq:s2}
    s_2 = \frac{2\pi}{3} \left(1 - \frac{3\Lambda(b,r)}{2} - \Theta(r - b) \right)
\end{align}
%
where $\Theta(\bigdot)$ is the Heaviside step function and
%
\begingroup\makeatletter\def\f@size{10}\check@mathfonts
\def\maketag@@@#1{\hbox{\m@th\large\normalfont#1}}%
\begin{align}
    \label{eq:biglam}
    \Lambda(b,r) &=
    \begin{dcases}
          % I don't think we need this: the k^2>1 term is stable as b --> 0!
          %-\frac{2}{3}\left(1 - r^2\right)^\frac{3}{2}
          %& \qquad b = 0
          %
          %\\[1.5em]
          %
          \frac{1}{9 \pi \sqrt{b r}} \Bigg[
                \frac{(r + b)^2 - 1}{r + b}
                \Big(
                    -2r \,
                    \big(
                        2 (r + b)^2 + (r + b)(r - b) - 3
                    \big)
                    K(k^2)
                    &\\ \phantom{XXXX}
                    + 3 (b - r) \, \Pi\big(k^2 (b + r)^2, \, k^2\big)
                \Big)
                - 4 b r (4 - 7 r^2 - b^2) E(k^2)
          \Bigg]
          %
          & \qquad k^2 < 1
          %
          \\[1.5em]
          %
          \frac{2}{9 \pi} \Bigg[
                \big(1 - (r + b)^2\big)
                \Bigg(
                    \sqrt{1 - (b - r)^2} \,
                    K\left(\frac{1}{k^2}\right)
                    + 3 \left(\frac{b-r}{(b+r)\sqrt{1 - (b - r)^2}}\right)
                    &\\ \phantom{XX}
                    \times \Pi\left(\frac{1}{k^2(b+r)^2}, \, \frac{1}{k^2}\right)
                \Bigg)
                - \sqrt{1 - (b - r)^2}
                (4 - 7 r^2 - b^2)
                E\left(\frac{1}{k^2}\right)
          \Bigg]
          %
          & \qquad k^2 \ge 1
    \end{dcases}
\end{align}
\endgroup
%
with
%
\begin{align}
    \label{eq:k2}
    k^2 &= \frac{1 - r^2 - b^2 + 2 b r}{4 b r}
    \quad.
\end{align}
For the cases $b=r$, $b=1-r$, $b=0$, $r=0$, or $\vert r-b\vert \ge 1$, there are special
expressions for $\Lambda(b,r)$ given below.
%
In the expressions above, $K(\bigdot)$, $E(\bigdot)$, and $\Pi(\bigdot, \bigdot)$
are the complete elliptic integrals of the first, second kind, and third kind,
respectively, defined as
%
\begin{align}
    \label{eq:elliptic}
    K(k^2) &\equiv \int_0^{\frac{\pi}{2}} \frac{\dd \varphi}{\sqrt{1 - k^2 \sin^2 \varphi}}
    \nonumber \\[0.5em]
    E(k^2) &\equiv \int_0^{\frac{\pi}{2}} \sqrt{1 - k^2 \sin^2 \varphi} \, \dd \varphi
    \nonumber \\[0.5em]
    \Pi(n, k^2) &\equiv \int_0^{\frac{\pi}{2}} \frac{\dd \varphi}{(1 - n \sin^2 \varphi)\sqrt{1 - k^2 \sin^2 \varphi}}
    \quad.
\end{align}
We have transformed the expressions from \citet{MandelAgol2002} using equation
17.7.17 from \citet{Abramowitz1970} which yields equations that are better
behaved in the vicinity of $b=r$.  However, these elliptic integrals are still
subject to numerical instability as $r \rightarrow 1-b$ and $r \gg 1$.  The main
issue is the logarithmic divergence of $K$ and $\Pi$ as $k \rightarrow 1$, as
well as numerical cancellations leading to round-off errors which occur in the 
limit $k \rightarrow 0$.

Through trial and error, we have found that these instabilities can be removed by combining
elliptic integrals into a general complete elliptic integral defined by \citet{Bulirsch1969} as
\begin{equation}
{\rm cel}(k_c,p,a,b) = \int_0^{\pi/2} \frac{a\cos^2{\phi} + b\sin^2{\phi}}{\cos^2{\phi}+p\sin^2{\phi}} \frac{d\phi}{\sqrt{\cos^2{\phi}+k_c^2\sin^2{\phi}}},
\end{equation}
where $k_c = \sqrt{1-m}$ where for $b+r \ge 1$,
$m=k^2$, while for $b+r \le 1$, $m=1/k^2$.  Although $k_c$ can be computed from
$m$, we have found better numerical stability in computing $k_c$ analytically
from $b$ and $r$, rather than from $m$:
\begin{align}
    k_c &=
    \begin{dcases}
     \sqrt{\frac{(b+r)^2-1}{4br}} & \qquad k^2 \le 1\\
     \sqrt{\frac{1-(b+r)^2}{1-(b-r)^2}} & \qquad k^2 > 1.
   \end{dcases}
\end{align}
In practice, we let the subroutine that computes ${\rm cel}$ accept both
$m$ and $k_c$ as input for numerical precision.

To transform the elliptic integrals in equation \ref{eq:biglam},
we used the following relations from \citet{Bulirsch1969}:
\begin{eqnarray}
\lambda K(m) + q E(m) &=& {\rm cel}(k_c,1,\lambda+q,\lambda+q k_c^2)\\
\lambda K(m) + q \Pi(n,m) &=& {\rm cel}(k_c,1-n,\lambda+q,\lambda+q k_c^2)\\
E(m) &=& {\rm cel}(k_c,1,1,1-m)\\
E(m)-(1-m)K(m) &=& m \, {\rm cel}(k_c,1,1,0)\\
\Pi(n,m)-K(m)  &=& n \, {\rm cel}(k_c,1-n,0,1),
\end{eqnarray}
noting that \citet{Bulirsch1969} uses a different sign convention for $\Pi(n,m)$.
In particular, the expressions for $\Pi(n,m)-K(m)$ and $E(m)-(1-m)K(m)$ are useful for eliminating
the singularities and cancellations which occur at $m=1$ when $b+r=1$ and $m=0$ when
$r \rightarrow \infty$.  The general complete elliptic integral is evaluated
with the approach of \citet{Bartky1938}, which uses recursion to approximate the
integral to a specified precision.

These elliptic integral transformations lead to the following numerically-stable
expression for the linear limb-darkening flux, $s_2(b,r)$,
\begin{align}
    \label{eq:biglam_stable}
    \Lambda &=
    \begin{dcases}
          0 & \qquad  r = 0\\
          0 & \qquad  \vert r- b\vert \ge 1\\
          -\tfrac{2}{3}(1-r^2)^{3/2} & \qquad b = 0\\
          \tfrac{1}{3} - \tfrac{4}{9\pi} & \qquad b = r = \tfrac{1}{2}\\
          \tfrac{1}{3} + \tfrac{2}{9\pi} {\rm cel}\left(k_c,1,m-3,(1-m)(2m-3)\right) & \qquad b= r < \tfrac{1}{2}\\
          \tfrac{1}{3} + \tfrac{1}{9\pi r} {\rm cel}\left(k_c,1,m-3,1-m\right) & \qquad b= r > \tfrac{1}{2}\\
          \tfrac{2}{9\pi}\left[3\cos^{-1}(1-2r) -2(3+2r-8r^2)\sqrt{rb}-3\pi\Theta(r-\tfrac{1}{2})\right] & \qquad b+r =1\\
          \frac{1-(b-r)^2}{9 \pi \sqrt{b r}} \Bigg[
                \frac{(b+r)^2-1}{4br}(b^2-r^2){\rm cel}(k_c,(b-r)^2(1-m),0,3)
                &\\ \phantom{XXXX}
               - (3-6r^2-2br){\rm cel}(k_c,1,1,0)-4brE(m)
          \Bigg]
          %
          & \qquad k^2 < 1
          %
          \\[1.5em]
          %
          \frac{2\sqrt{1-(b-r)^2}}{9 \pi} \Bigg[
                \big(1 - (r + b)^2\big)
                {\rm cel}(k_c,p,1+q,p+q) &\\ \phantom{XXXX}
                - (4 - 7 r^2 - b^2)
                E\left(m\right)
          \Bigg]
          %
          & \qquad k^2 > 1\\
    \end{dcases}
\end{align}
where
\begin{eqnarray}
q &=& 3\frac{b-r}{(b+r)(1-(b-r)^2)}\\
p &=& \left(\frac{b-r}{b+r}\right)^2 \frac{1-(b+r)^2}{1-(b-r)^2}
\end{eqnarray}
in the $k^2 > 1$ case.  Note that in this equation the conditions
should be evaluated in the order they appear, and several typos
are corrected from \citet{MandelAgol2002}.

The $s_2(b,r)$ function is plotted in Figure \ref{s2_plot}.  The
function varies smoothly from the lower right where the disk is
unocculted to the upper left where it is completely occulted.
There are several points which need to be handled separately as
the equation \ref{eq:biglam} expressions become singular or are
no longer valid;  the solid lines in Figure \ref{s2_plot} show
these points.  When $b=0$, the integral over the center of the
disk simplifies greatly.  When $b=r=1/2$, at the intersection of
$b=r$ and $b=1-r$, another simplification occurs.  For $b=r$,
the disk of the occultor crosses the center of the source;
this needs to be computed separately in the $r<1/2$, $r=1/2$,
and $r>1/2$ limits.  The first and fourth contacts occur at
$b=1+r$, where $s_2=1$;  this is the upper bound to the $k^2 < 1$
region for $b+r >1$.
For $r \ge 1$, the second and third contacts (at the start and
end of complete occultation) occur when $b=1-r$, which is the
lower  bound to the $k^2<1$ region when $b+r >1$.
For $r < 1$, the second and third contacts occur when $r=1-b$.

Near these boundaries, the standard \citet{MandelAgol2002} expression
can become singular, and so we paid particular care to the accuracy of this
new expression in these regions.  Figure \ref{s2_machine} shows
that equation \ref{eq:biglam_stable} is accurate in these regimes.
We tested the accuracy by computing the equations with 256 bit
arithmetic, which is much less subject to round-off error, and
hence gives essentially exact expressions.  We implemented the
pseudocode from \citet{Bulirsch1969} to compute ${\rm cel}(k_c,p,a,b)$,
which has a termination test that scales as the square root of
the machine precision.  We find that the transformed expressions
are accurate to $\la \times 10^{-15}$ when computed in double precision
within $10^{-8}$ of the vicinity of $b=r$ and $b=1-r$.

\begin{figure}\label{transit_linear}
    \begin{centering}
    \includegraphics[width=0.85\linewidth]{figures/julia/transit_linear.pdf}
    \caption{The intensity of a linearly limb-darkened star ($u_1=1$) being
    eclipsed, $s_2(b,r)$.
    In the limit $b > r+1$, no eclipse occurs, so $s_2=1$.  For $b < r-1$, the star
    is completely eclipsed and $s_2=0$.  In the limits $b=r$ and $b=1-r$, special
    expressions must be used}
    \end{centering}
\end{figure}

\begin{figure}\label{s2_plot}
    \begin{centering}
    \includegraphics[width=0.85\linewidth]{figures/julia/s2_residuals.pdf}
    \caption{The numerical error in computing the flux of an eclipsed,  linearly
    limb-darkened star ($u_1=1$), $s_2(b,r)$.}
    \end{centering}
\end{figure}

\begin{figure}\label{s2_machine}
    \begin{centering}
    \includegraphics[width=\linewidth]{figures/julia/s2_machine.pdf}
    \caption{The accuracy of $s_2(b,r)$ near $b=r$ (left panel) and
    $b=1-r$ (right panel). The x-axese are impact parameter b,
    while the y axes in the top panels show $s_2(b,r)$, with $r$
    given in the legend of each panel. The middle panels plot
    the difference $(s_2(b,b\pm\epsilon)-s_2(b,b))/\epsilon$
    and $(s_2(b,1-b\pm\epsilon)-s_2(b,1-b))/\epsilon$. The bottom
    panels show the numerical precision by the comparing double precision
    computation with \texttt{BigFloat} precision (256-bit).}
    \end{centering}
\end{figure}


From \citet{MandelAgol2002}, the total flux visible during the occultation of a
body whose surface map is given by $I(\upmu)/I(1) = 1 - u_1(1 - \upmu)$ may be computed
as
\begin{eqnarray}
\frac{F(u_1,b,r)}{F_0} &=& \frac{u_1 s_2(b,r) + \pi(1-u_1)(1-\Lambda^e)}{\frac{2\pi}{3}u_1 + \pi(1-u_1)},\\
&=& 1-(1-u_1/3)^{-1}\left[(1-u_1)\Lambda^e(b,r) + u_1\left(\Lambda(b,r)+\tfrac{2}{3}\Theta(r-b)\right)\right],
\end{eqnarray}
where
\begin{align}
\Lambda^e(b,r) &=
\begin{dcases}
0 & \qquad 1+r \le b,\\
\frac{1}{\pi}\left[r^2 \cos^{-1}\left(\frac{1-r^2+b^2}{2b}\right) + \cos^{-1}\left(\frac{r^2+b^2-1}{2br}\right) \right.
                &\\ \phantom{XXXX}
\left.-\sqrt{\frac{4b^2-(1+b^2-r^2)^2}{4}}\right] & \qquad \vert 1-r\vert < b \le 1+r,\\
r^2 & \qquad b \le 1-r,\\
1 & \qquad b \le r-1,\\
\end{dcases}
\end{align}
and $F_0$ is the total unocculted flux.  % Note:  I'm not using this in 
% transit_poly since it is not as precise as the starry expressions.

% ==============================================================================
% ------------------------------------------------------------------------------
% ------------------------------------------------------------------------------
%
\clearpage
\section{Polynomial Limb-Darkening}
\label{sec:quad}
% ------------------------------------------------------------------------------
% ------------------------------------------------------------------------------
% ==============================================================================

In analogy with the linear and quadratic
limb-darkening laws, let us define the polynomial limb-darkening law of
order $l_\mathrm{max}$ as
%
%
\begin{align}
    \label{eq:polynomialld}
    \frac{I(\upmu)}{I(1)} &= 1 - u_1 (1 - \upmu) - u_2 (1 - \upmu)^2 - ... - u_{l_\mathrm{lmax}}(1 - \upmu)^{l_\mathrm{lmax}} \nonumber \\
                          &= \sum_{l=0}^{l_\mathrm{lmax}} \sum_{k=0}^l u_l {l \choose k} (-1)^k \upmu^k
    \quad,
\end{align}
%
where $u_0 \equiv 1$. For convenience, this can be expressed as the matrix equation
%
\begin{align}
    \label{eq:polynomialldmatrix}
    \frac{I(\upmu)}{I(1)} &= \bvec{u}^\top \, \bvec{L} \, \pmb{\upmu}
    \quad,
\end{align}
%
where $\bvec{u}^\top$ is a row vector whose value at index
$l$ is $u_l$, $\pmb{\upmu}$ is a column vector whose value at index $k$ is $\upmu^k$,
and $\bvec{L}$ is the lower triangular matrix with components given by
%
\begin{align}
    \label{eq:Llk}
    L_{lk} = {l \choose k} (-1)^k
    \quad.
\end{align}
%
It is straightforward to show that this law can be
expressed exactly as a sum over the $m = 0$ spherical harmonics, which also
form a complete basis of radially symmetric functions on the sphere.
%
Based on the relations in \citet{starry} for the spherical harmonics in Cartesian
form, the spherical harmonics of order $m = 0$ may be written
%
\begin{align}
    \label{eq:Ylzero}
    Y_{l,0}(\upmu) = \sqrt{\frac{2l + 1}{4\pi}}
              \sum_{k=0}^l {l \choose k} \frac{(k + l - 1)!!}{(k - l - 1)!!} \upmu^k
\end{align}
%
where $\upmu = z = \sqrt{1 - x^2 - y^2}$, $\binom{\bigdot}{\bigdot}$ is a binomial
coefficient, and $!!$ denotes the double factorial.

Our task now is to express the specific intensity function (\ref{eq:polynomialldmatrix})
in the basis of spherical harmonics (\ref{eq:Ylzero}). We therefore wish to find
the coefficients $c_l$ for which we may write
%
\begin{align}
    \label{eq:sphharmld}
    \frac{I(\upmu)}{I(1)} &= \sum_{l=0}^{l_\mathrm{lmax}} c_l Y_{l,0}(\upmu)
    \quad.
\end{align}
%
As before, we can write this as the matrix equation
%
\begin{align}
    \label{eq:sphharmldmatrix}
    \frac{I(\upmu)}{I(1)} &= \bvec{c}^\top \, \bvec{M} \, \pmb{\upmu}
    \quad,
\end{align}
%
where $\bvec{c}^\top$ is a row vector whose value at index
$l$ is $c_l$ and $\bvec{M}$ is the lower triangular matrix with components given by
%
\begin{align}
    \label{eq:Mlk}
    M_{lk} = \sqrt{\frac{2l + 1}{4\pi}} {l \choose k} \frac{(k + l - 1)!!}{(k - l - 1)!!}
    \quad.
\end{align}
%
Equating Equations~(\ref{eq:polynomialldmatrix}) and (\ref{eq:sphharmldmatrix}), we see
that we must have
%
\begin{align}
    \bvec{c}^\top \, \bvec{M} = \bvec{u}^\top \, \bvec{L} \quad,
\end{align}
%
or
%
\begin{align}
    \bvec{c} = (\bvec{M}^{-1} \, \bvec{L})^\top \bvec{u} \quad.
\end{align}
%
In \citet{starry} we described how to compute analytic transit and occultation light curves
for bodies whose surfaces are expressed as a sum over spherical harmonic coefficients. We
defined a body's surface map as the vector of spherical harmonic coefficients $\bvec{y}$.
The vector $\bvec{y}$ corresponding to our coefficients for the $Y_{l,0}$ harmonics is
related to $\bvec{c}$ via
%
\begin{align}
    y_{l(l + 1)} &= c_l
\end{align}
%
for $0 \leq l \leq l_\mathrm{max}$, where the values at all other indices in $\bvec{y}$ are zero.

\begin{figure}[t!]
    \begin{centering}
    \includegraphics[width=\linewidth]{figures/python/high_order_ld.pdf}
    \caption{\label{fig:high_order_ld} Tenth order limb-darkening example with \starry. }
    \end{centering}
\end{figure}

{\color{red}We should derive simplified expressions of our formulae in \starry for the $m = 0$ case.} \todo{}

\begin{align}
    \label{eq:PGnI}
    \mathcal{P}(\bvec{G}_n) &=
    \begin{dcases}
        %
        r^{l+2} \sum\displaylimits_{i=0}^{\frac{l}{2}}
                {\frac{l}{2} \choose i}
                \left(\frac{b}{r}\right)^{\frac{l-2i}{2}}
                \mathcal{I}_{\frac{l+4}{2}, i}
            %
            & \qquad \frac{l}{2} \, \mathrm{even}
        \\[1em]
        %
        -r^{l-2} \left( b \mathcal{J}_{l-3,1} + r \mathcal{J}_{l-3,2} \right)
        %
        & \qquad l = 1
        \\[1em]
        %
        r^{l-1} \sum\displaylimits_{i=0}^{\frac{l-1}{2}}
                {\frac{l-1}{2} \choose i}
                \left(\frac{b}{r}\right)^{\frac{l-2i-1}{2}}
                \mathcal{J}_{\frac{l-1}{2}, i}
            & \qquad \frac{l-1}{2} \, \mathrm{even}
        \\[1em]
        %
        0 & \qquad \mathrm{otherwise}
    \end{dcases}
%
\end{align}
%
\begin{align}
%
    \nonumber \\
    \label{eq:QGnI}
    \mathcal{Q}(\bvec{G}_n) &=
    \begin{dcases}
        \mathcal{H}_{\frac{l+4}{2}, \frac{l}{2}}
        & \qquad \qquad \qquad \qquad \quad \quad \quad \quad \frac{l}{2} \, \mathrm{even}
        \\[1em]
        %
        0
        & \qquad \qquad \qquad \qquad \quad \quad \quad \quad \mathrm{otherwise} \quad.
    \end{dcases}
\end{align}

\bibliography{limbdark}

\appendix

\section{Green's function expansion}

Since the polynomial expansion only depends on $\upmu = z =\sqrt{1-x^2+y^2}$,
where $(x,y,z)$ are the coordinates of the unit sphere, then we only require
Green's functions which have a dependence on $z$ for axially-symmetric
limb-darkening.  We choose a Green's function of the form
\begin{equation}
\mathbf{G}_n = f(z) (-y \xhat + x \yhat)
\end{equation}
giving
\begin{eqnarray}
\gbasisn(x,y) &=& \frac{\dd {G_n}_y}{\dd \x} - \frac{\dd {G_n}_x}{\dd \y}\\
&=& 2 f(z) + \frac{df}{dz} \frac{z^2-1}{z}.
\end{eqnarray}
This yields particularly simple form for the primitive integrals of
\begin{align}
    \label{eq:primitiveP}
    \mathcal{P}(\bvec{G}_n) &=
    \int\displaylimits_{\pi-\phi}^{2\pi + \phi} f(z) (r+b \sin{\varphi}) d\varphi
    %
\intertext{and}
    %
    \label{eq:primitiveQ}
    \mathcal{Q}(\bvec{G}_n) &=
    \int\displaylimits_{\pi-\lambda}^{2\pi + \lambda} f(z) d \varphi
\end{align}

We choose $f(z) = z^n$, so that
\begin{equation}
\gbasisn(x,y) =  (n+2)z^n-n z^{n-2},
\end{equation}
is the basis set for polynomial limb-darkening, along with the uniform, $\tilde{g}_0 = z^0$,
and linear, $\tilde{g}_1 = z^1$, terms which we have derived in \S \ref{sec:reparam}.

With this choice of basis, the primitive integral $\mathcal{Q}(\bvec{G}_n) = 0$ for 
$n \ge 1$ since $z=0$ at the boundary of the star.   The $n=0$ case we have already
solved for uniform limb-darkening.

The primitive integral
$\mathcal{P}(\bvec{G}_n)$ also takes a simple form
\begin{equation}
\mathcal{P}(\bvec{G}_n) = 
\int_{\pi-\phi}^{2\pi + \phi} \left(1-r^2-b^2-2br s_\varphi\right)^{\frac{n}{2}} (r+b s_\varphi) r d\varphi.
\end{equation}
We make the transformation $\xi = \tfrac{1}{2} \left(\varphi - \tfrac{3\pi}{2}\right)$, yielding
\begin{equation}
\mathcal{P}(\bvec{G}_n) = 
2r (4br)^{\frac{n}{2}}\int\displaylimits_{-\tfrac{\kappa}{2}}^{\tfrac{\kappa}{2}} 
(k^2-\sin^2\xi)^{\tfrac{n}{2}} (r-b + 2b \sin^2 \xi) d\xi,
\end{equation}
for even values of $n$ and 
\begin{equation}
\mathcal{P}(\bvec{G}_n) =
2r (4br)^{\frac{n}{2}} k^3 \int\displaylimits_{-\tfrac{\kappa}{2}}^{\tfrac{\kappa}{2}} 
(k^2-\sin^2\xi)^{\tfrac{n-3}{2}} (1-k^{-2} \sin^2 \xi)^{3/2} (r-b + 2b \sin^2 \xi) d\xi,
\end{equation}
for odd values of $n \ge 3$, where $\kappa = 2 \cos^{-1}k$ for $k^2 \le 1$ and
$\kappa = \pi/2$ for $k^2 > 1$.

Each of the terms $(k^2-\sin^2\xi)^c$ can be exanded with the binomial theorem,
and then expressed in terms of the integrals $\mathcal{I}_v(k)$ and $\mathcal{J}_v(k)$ as
\begin{eqnarray}
\mathcal{P}(\mathbf{G}_n) &=& \\
&=& 2r(4br)^{n_0} \sum_{i=0}^{n_0} \binom{n_0}{i}(-1)^{n_0-i} k^{2i} \left[(r-b)\mathcal{I}_{n_0-i} + 2b \mathcal{I}_{n_0-i+1}\right]\\ 
&=& 2r(1-(r-b)^2)^3(4br)^{n_0} \sum_{i=0}^{n_0} \binom{n_0}{i} (-1)^{n_0-i} k^{2i} \left[(r-b)\mathcal{J}_{n_0-i} + 2b \mathcal{J}_{n_0-i+1}\right],
\end{eqnarray}
where $n_0 = n/2$ for even $n$ and $n_0 = (n-3)/2$ for odd $n \ge 3$,

\section{Limb-darkening coefficients}

Our expansion for limb-darkening in terms of $u_n(1-\upmu)^n$ needs to
be expressed in terms of the Green's basis terms $c_n \left[(n+2)\upmu^n -n \upmu^{n-2}\right]$.
We accomplish this by first transforming $u_n$ to coefficients of $a_n \upmu^n$,
and then transforming from $a_n$ to $c_n$.

We rewrite $I(\upmu)$ in terms of these three expansions
\begin{eqnarray}
I(\upmu) &=& 1 - \sum_{i=1}^N u_i \sum_{j=0}^i \binom{i}{j} (-1)^j \upmu^j,\\
&=& \sum_{n=0}^N a_n \upmu^n,\\
&=& c_0 + c_1 \upmu + \sum_{n=2}^N c_n \left[(n+2)\upmu^n -n \upmu^{n-2}\right].
\end{eqnarray}
The transformation between $u_n$ and $a_n$ is straightforward based on
looping over the binomial expansion of each of the $u_n$ terms.  Then,
with the computed $a_n$ values, we find $c_n = a_n/(n+2) + c_{n+2}$,
where $c_{N+1}=c_{N+2}=0$.

The total light curve is computed from
\begin{equation}
F = \frac{\sum_{n=0}^N c_n s_n}{\pi(c_0+ \tfrac{2}{3} c_1)}
\end{equation}
where $s_n = \mathcal{Q}(\bvec{G}_n) - \mathcal{P}(\bvec{G}_n)$ for $n \ne 1$,
and $s_1$ is given by the linear limb-darkened solution from section \ref{sec:reparam}.
We note that the unobscured flux (for $b \ge 1+r$ or $r=0$) is zero for
all $s_n(r,b)$ with $n \ge 2$.

\section{Analytic derivatives}

For computing the derivatives of $\mathcal{P}(\bvec{G}_n)$, we find it more numerically 
stable to express the $k^2$ terms in terms of $b$ and $r$:
\begin{eqnarray}
\mathcal{P}(\mathbf{G}_n) &=& 2r \sum_{i=0}^{n_0} T_i U_i\\
&=& 2r(1-(r-b)^2)^{3/2} \sum_{i=0}^{n_0} T_i V_i,
\end{eqnarray}
where the first line is for even $n$ and the second for odd $n \ge 3$, and
for compactness, we define
\begin{eqnarray}
T_i &=&  \binom{n_0}{i}(-4br)^{n_0-i}(1-(b-r)^2)^{2i},\\
U_i &=&  \left[(r-b)\mathcal{I}_{n_0-i} + 2b \mathcal{I}_{n_0-i+1}\right],\\
V_i &=&  \left[(r-b)\mathcal{J}_{n_0-i} + 2b \mathcal{J}_{n_0-i+1}\right],
\end{eqnarray}
We then express the derivatives as
\begin{eqnarray}
\frac{d \mathcal{P}}{d r} = \frac{\partial \mathcal{P}}{\partial r}  +  \frac{\partial \mathcal{P}}{\partial k} \frac{\partial k}{\partial r},\\
\frac{d \mathcal{P}}{d b} = \frac{\partial \mathcal{P}}{\partial b}  +  \frac{\partial \mathcal{P}}{\partial k} \frac{\partial k}{\partial b}.
\end{eqnarray}

Then, these partial derivatives are given by:
\begin{eqnarray}
\frac{\partial \mathcal{P}}{\partial r}  &=& \frac{\mathcal{P}}{r}+2r\sum_{i=0}^{n_0} T_i  \left[\left(\frac{2i(b-r)}{1-(b-r)^2} + \frac{n_0-i}{r}\right) U_i + \mathcal{I}_{n_0-i}\right],\\
\frac{\partial \mathcal{P}}{\partial b}  &=& 2r\sum_{i=0}^{n_0} T_i  \left[\left(\frac{2i(r-b)}{1-(b-r)^2} + \frac{n_0-i}{b}\right) U_i - \mathcal{I}_{n_0-i} + 2\mathcal{I}_{n_0-i+1}\right],\\
\frac{\partial \mathcal{P}}{\partial k}  &=& 2r\sum_{i=0}^{n_0} T_i  \left[(r-b) \frac{\partial \mathcal{I}_{n_0-i}}{\partial k} + 2b \frac{\partial \mathcal{I}_{n_0-i+1}}{\partial k}\right],
\end{eqnarray}
for even $n$ and
\begin{eqnarray}
\frac{\partial \mathcal{P}}{\partial r}  &=& \left(\frac{\mathcal{P}}{r}+\frac{3\mathcal{P}(b-r)}{1-(b-r)^2}\right)  + \mathcal{F}\sum_{i=0}^{n_0} T_i \left[\left(\frac{2i(b-r)}{1-(b-r)^2} + \frac{n_0-i}{b}\right) V_i + \mathcal{J}_{n_0-i}\right],\\
\frac{\partial \mathcal{P}}{\partial b}  &=& \frac{3\mathcal{P}(r-b)}{1-(b-r)^2}  +\mathcal{F}\sum_{i=0}^{n_0} T_i \left[\left(\frac{2i(r-b)}{1-(b-r)^2} + \frac{n_0-i}{b}\right) V_i - \mathcal{J}_{n_0-i} + 2\mathcal{J}_{n_0-i+1}\right],\\
\frac{\partial \mathcal{P}}{\partial k}  &=& \mathcal{F}\sum_{i=0}^{n_0} T_i \left[(r-b) \frac{\partial\mathcal{J}_{n_0-i}}{\partial k} + 2b \frac{\partial \mathcal{J}_{n_0-i+1}}{\partial k}\right],\\
\end{eqnarray}
for odd $n \ge 3$ where $\mathcal{F} = 2r(1-(b-r)^2)^{3/2}$.

The partial derivatives of $k$ are given by
\begin{eqnarray}
\frac{\partial k}{\partial r} &=& \frac{b^2-r^2-1}{8 k b r^2},\\
\frac{\partial k}{\partial b} &=& \frac{r^2-b^2-1}{8 k b^2 r}.
\end{eqnarray}

Finally, we need the derivatives of the function $\mathcal{I}_v$ and $\mathcal{J}_v$
with respect to $k$.  This is given by recursion relations
\begin{eqnarray}
\frac{\partial \mathcal{J}_v}{\partial k} &=& -3 k^{-1} \mathcal{J}_v +k^2 \frac{\partial \mathcal{J}_{v-1}}{\partial k},\\
&=& 3 k^{2v} \int_0^1 u^{v+\tfrac{1}{2}} (1-u)^{1/2} (1-k^2u)^{-1/2}du,\\ 
&=& 3 k^{2v} \frac{\sqrt{\pi}}{2} \Gamma(v+\tfrac{3}{2}) \,_2{\tilde F}_1(\tfrac{1}{2},v+\tfrac{3}{2},3+v,k^2),\\
\frac{\partial \mathcal{J}_0}{\partial k} &=& \frac{2}{k^4}\left[(2-k^2)E(k^2)+2(k^2-1)K(k^2)\right],
\end{eqnarray}
for $k^2 < 1$ ($b+r > 1$) and an expression for $I_v$
\begin{equation}
\frac{\partial \mathcal{I}_v}{\partial k} = 2k^{2v} k_c^{-1}.
\end{equation}

For $k^2 > 1$ ($b+r <1$), we have
\begin{eqnarray}
\frac{\partial \mathcal{J}_0}{\partial k} &=& k^{-3} \left[2(2-k^2)E(k^{-2}) + 2(k^2-1) K(k^{-2})\right]\\ 
\frac{\partial \mathcal{J}_v}{\partial k} &=& (-1)^{v+1} \frac{3k^{-3}\pi^{3/2}}{\Gamma(-(v+\tfrac{1}{2}))} \,_2\tilde{F}_1(-\tfrac{1}{2},v+\tfrac{3}{2},v+2,k^{-2})
\end{eqnarray}
while the same recursion relation applies for $\partial \mathcal{J}_v/\partial k$ as in the $k^2 < 1$ case,
and $d\mathcal{I}_v/dk = 0$.

As with STARRY, we find that upward recursion is more stable for $\tfrac{1}{2} < k^2 < 2$,
while downward recursion is more stable for $k^2 < \tfrac{1}{2}$ and $k^2 > 2$.  This
requires computing the derivatives, $\frac{\partial \mathcal{J}_v}{\partial k}$, first 
for large values of $k$. Rather than using the integral or Hypergeometric functions given
above, we accomplish this by differentiating each term the series expansion for 
$\mathcal{J}_v$ with respect to $k$.  TBD

With the computation of $s_n = -\mathcal{P}(\bvec{G}_n)$ for $n \ge 2$, we then
compute the derivatives of the light curve as 
\begin{eqnarray}
\frac{\partial s_n}{\partial r} &= & -\frac{\partial \mathcal{P}(\bvec{G}_n)}{\partial r},\\
\frac{\partial s_n}{\partial b} &= & -\frac{\partial \mathcal{P}(\bvec{G}_n)}{\partial b},
\end{eqnarray}
for $n \ge 2$, while the $n=0$ and $n=1$ terms must be handled separately as in
section \ref{sec:reparam}.

The light curve derivatives are also simply computed as
\begin{eqnarray}
\frac{\partial F}{\partial r} &=& \sum_{n=0}^N\frac{ c_n}{\pi(c_0+ \tfrac{2}{3} c_1)} \frac{\partial s_n}{\partial r},\\
\frac{\partial F}{\partial c_0} &=&  -\frac{ F}{c_0+ \tfrac{2}{3} c_1} + \frac{\frac{\partial s_0}{\partial r}}{\pi(c_0+ \tfrac{2}{3} c_1)},\\
\frac{\partial F}{\partial c_1} &=&  -\frac{2 F}{3(c_0+ \tfrac{2}{3} c_1)} +\frac{\frac{\partial s_1}{\partial r}}{\pi(c_0+ \tfrac{2}{3} c_1)},\\
\frac{\partial F}{\partial c_n} &=&  \frac{\frac{\partial s_n}{\partial r}}{\pi(c_0+ \tfrac{2}{3} c_1)},
\end{eqnarray}
where the last line is for $n \ge 2$.

The derivatives of the coefficients, $\frac{\partial u_i}{\partial c_j}$, are 
computed by differentiating each term, and propagating the derivatives via the
chain rule.  Then, the light curve derivatives are given by
\begin{eqnarray}
\frac{\partial F}{\partial u_i} =  \sum_{j} \frac{\partial F}{\partial c_j}\frac{\partial c_j}{\partial u_i}.
\end{eqnarray}

\end{document}
